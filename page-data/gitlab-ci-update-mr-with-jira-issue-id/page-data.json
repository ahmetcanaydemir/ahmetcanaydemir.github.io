{"componentChunkName":"component---src-templates-blog-post-js","path":"/gitlab-ci-update-mr-with-jira-issue-id/","result":{"data":{"site":{"siteMetadata":{"title":"Ahmet Can Aydemir","author":"Ahmet Can Aydemir"}},"markdownRemark":{"id":"4c361e11-fe44-5b65-b129-d8c3ba6b62d6","html":"<p><a href=\"/x/\"></a></p>\n<p>In <a href=\"/git-hooks-enforce-commit-message-and-branch-name/\">my previous article</a>, we enforced branch names and commit messages to certain rules. Now I will go a step further. When a MR is opened, if there is Jira issue id (eg. ISSUE-0000) in the title, we will pull the Jira title and description and update MR. CI will fail if there is no Jira Issue Id in the title.</p>\n<hr>\n<p>To do this, we can briefly follow these steps.</p>\n<ol>\n<li>Check if there is an issue id in the MR title. Otherwise, return fail exit code. We will use regex for this. <code class=\"language-text\">$CI_MERGE_REQUEST_TITLE</code> will give us the MR header.</li>\n<li>Extract Issue Id and pull data from Jira API. When you make a GET request to the <code class=\"language-text\">https://jira.&lt;your-hostname&gt;/rest/api/2/issue/ISSUE-0000</code> jira address, Issue details will be returned to you as JSON.</li>\n<li>Take the <code class=\"language-text\">summary</code> and <code class=\"language-text\">description</code> parts from the json data returned by Jira API wit jq and assign them to variables.</li>\n<li>Update MRâ€™s title and description using GitLab API.</li>\n</ol>\n<hr>\n<h2 id=\"curl-ve-jq-setup\"><a href=\"#curl-ve-jq-setup\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Curl ve jq Setup</h2>\n<p>We need <code class=\"language-text\">curl</code> for our API requests and <code class=\"language-text\">jq</code> to parse JSON.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">apk <span class=\"token function\">add</span> --update <span class=\"token function\">curl</span> <span class=\"token operator\">&amp;&amp;</span> apk <span class=\"token function\">add</span> --update jq <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">rm</span> -rf /var/cache/apk/*</code></pre></div>\n<hr>\n<h2 id=\"issue-id-check\"><a href=\"#issue-id-check\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Issue Id Check</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">REGEX_ISSUE_ID</span><span class=\"token operator\">=</span><span class=\"token string\">\"^(ISSUE-[0-9]+)\"</span>\n<span class=\"token assign-left variable\">ISSUE_ID_IN_MR</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$CI_MERGE_REQUEST_TITLE</span>\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> -o -E <span class=\"token string\">\"<span class=\"token variable\">$REGEX_ISSUE_ID</span>\"</span><span class=\"token variable\">)</span></span>\n<span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> -z <span class=\"token string\">\"<span class=\"token variable\">$ISSUE_ID_IN_MR</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span> <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">fi</span> </code></pre></div>\n<hr>\n<h2 id=\"jira-issue-parsing\"><a href=\"#jira-issue-parsing\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Jira Issue Parsing</h2>\n<p>We store new lines (eg. <code class=\"language-text\">\\n</code>) as characters in <code class=\"language-text\">DESCRIPTION_JSON</code> variable because new lines are problem when sending curl requests.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">JSON</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> -s -u <span class=\"token operator\">&lt;</span>jira-username<span class=\"token operator\">></span>:<span class=\"token operator\">&lt;</span>jira-password<span class=\"token operator\">></span> -X GET -H <span class=\"token string\">\"Content-Type:application/json\"</span> <span class=\"token string\">\"https://jira.&lt;your-hostname>/rest/api/2/issue/<span class=\"token variable\">$ISSUE_ID_IN_MR</span>\"</span><span class=\"token variable\">)</span></span>\n\n<span class=\"token assign-left variable\">SUMMARY</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$JSON</span>\"</span> <span class=\"token operator\">|</span> jq -r <span class=\"token string\">\".fields.summary\"</span><span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">DESCRIPTION</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$JSON</span>\"</span> <span class=\"token operator\">|</span> jq -r <span class=\"token string\">\".fields.description\"</span><span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">DESCRIPTION_JSON</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>jq --null-input --compact-output --arg msg <span class=\"token string\">\"<span class=\"token variable\">$DESCRIPTION</span>\"</span> <span class=\"token string\">'<span class=\"token variable\">$msg</span>'</span><span class=\"token variable\">)</span></span></code></pre></div>\n<hr>\n<h2 id=\"updating-merge-request\"><a href=\"#updating-merge-request\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Updating Merge Request</h2>\n<p>You need private token for this <a href=\"https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">check GitLab documentation</a> and learn how to do that.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">curl</span> -v <span class=\"token punctuation\">\\</span>\n--data <span class=\"token string\">\"{<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>title<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>: <span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">${ISSUE_ID_IN_MR}</span> <span class=\"token variable\">${SUMMARY}</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>description<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>: <span class=\"token variable\">${DESCRIPTION_JSON}</span>}\"</span> <span class=\"token punctuation\">\\</span>\n--fail <span class=\"token punctuation\">\\</span>\n--header <span class=\"token string\">\"Content-Type:application/json; charset=utf-8\"</span> <span class=\"token punctuation\">\\</span>\n--header <span class=\"token string\">\"PRIVATE-TOKEN:&lt;private-token>\"</span> <span class=\"token punctuation\">\\</span>\n--output <span class=\"token string\">\"/dev/null\"</span> <span class=\"token punctuation\">\\</span>\n--request PUT <span class=\"token punctuation\">\\</span>\n--show-error <span class=\"token punctuation\">\\</span>\n--silent <span class=\"token punctuation\">\\</span>\n--trace-ascii <span class=\"token string\">\"/dev/stderr\"</span> <span class=\"token punctuation\">\\</span>\n--write-out <span class=\"token string\">\"HTTP response: %{http_code}<span class=\"token entity\" title=\"\\n\">\\n</span><span class=\"token entity\" title=\"\\n\">\\n</span>\"</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token string\">\"<span class=\"token variable\">${CI_API_V4_URL}</span>/projects/<span class=\"token variable\">${CI_PROJECT_ID}</span>/merge_request<span class=\"token variable\">$CI_MERGE_REQUEST_IID</span>\"</span></code></pre></div>\n<hr>\n<h2 id=\"result\"><a href=\"#result\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Result</h2>\n<p>When we combine all this into one GitLab CI yml file it will look like this.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">check_mr</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> alpine\n  <span class=\"token key atrule\">stage</span><span class=\"token punctuation\">:</span> test\n  <span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> apk add <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>update curl <span class=\"token important\">&amp;&amp;</span> apk add <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>update jq <span class=\"token important\">&amp;&amp;</span> rm <span class=\"token punctuation\">-</span>rf /var/cache/apk/*\n    <span class=\"token punctuation\">-</span> IFS=$\"\\n\"\n    <span class=\"token punctuation\">-</span> REGEX_ISSUE_ID=\"^(ISSUE<span class=\"token punctuation\">-</span><span class=\"token punctuation\">[</span>0<span class=\"token punctuation\">-</span><span class=\"token number\">9</span><span class=\"token punctuation\">]</span>+)\"\n    <span class=\"token punctuation\">-</span> ISSUE_ID_IN_MR=$(echo \"$CI_MERGE_REQUEST_TITLE\" <span class=\"token punctuation\">|</span> grep <span class=\"token punctuation\">-</span>o <span class=\"token punctuation\">-</span>E \"$REGEX_ISSUE_ID\")\n    <span class=\"token punctuation\">-</span> if <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token punctuation\">-</span>z \"$ISSUE_ID_IN_MR\" <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>; then exit 1; fi \n    <span class=\"token punctuation\">-</span> JSON=$(curl <span class=\"token punctuation\">-</span>s <span class=\"token punctuation\">-</span>u &lt;jira<span class=\"token punctuation\">-</span>username<span class=\"token punctuation\">></span><span class=\"token punctuation\">:</span>&lt;jira<span class=\"token punctuation\">-</span>password<span class=\"token punctuation\">></span> <span class=\"token punctuation\">-</span>X GET <span class=\"token punctuation\">-</span>H \"Content<span class=\"token punctuation\">-</span>Type<span class=\"token punctuation\">:</span>application/json\" \"https<span class=\"token punctuation\">:</span>//jira.&lt;your<span class=\"token punctuation\">-</span>hostname<span class=\"token punctuation\">></span>/rest/api/2/issue/$ISSUE_ID_IN_MR\")\n    <span class=\"token punctuation\">-</span> SUMMARY=$(echo \"$JSON\" <span class=\"token punctuation\">|</span> jq <span class=\"token punctuation\">-</span>r \".fields.summary\")\n    <span class=\"token punctuation\">-</span> DESCRIPTION=$(echo \"$JSON\" <span class=\"token punctuation\">|</span> jq <span class=\"token punctuation\">-</span>r \".fields.description\")\n    <span class=\"token punctuation\">-</span> DESCRIPTION_JSON=$(jq <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>null<span class=\"token punctuation\">-</span>input <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>compact<span class=\"token punctuation\">-</span>output <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>arg msg \"$DESCRIPTION\" '$msg')\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n      curl -v \\\n      --data \"{\\\"title\\\": \\\"${ISSUE_ID_IN_MR} ${SUMMARY}\\\", \\\"description\\\": ${DESCRIPTION_JSON}}\" \\\n      --fail \\\n      --header \"Content-Type:application/json; charset=utf-8\" \\\n      --header \"PRIVATE-TOKEN:&lt;private-token>\" \\\n      --output \"/dev/null\" \\\n      --request PUT \\\n      --show-error \\\n      --silent \\\n      --trace-ascii \"/dev/stderr\" \\\n      --write-out \"HTTP response: %{http_code}\\n\\n\" \\\n      \"${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/$CI_MERGE_REQUEST_IID\"</span>\n    <span class=\"token key atrule\">only</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> merge_requests</code></pre></div>\n<hr>\n<p>You should add this file you created to your GitLab project as a CI file. After all these processes, your MR titles and descriptions will now be much more organized and understandable!</p>","timeToRead":3,"frontmatter":{"title":"GitLab CI: Update MR with Jira Issue Id","date":"December 02, 2021","spoiler":"Update MR title and description with Jira Issue Id"},"fields":{"slug":"/gitlab-ci-update-mr-with-jira-issue-id/","langKey":"en"}}},"pageContext":{"slug":"/gitlab-ci-update-mr-with-jira-issue-id/","previous":{"fields":{"slug":"/git-hooks-enforce-commit-message-and-branch-name/","langKey":"en","directoryName":"git-hooks-enforce-commit-message-and-branch-name","maybeAbsoluteLinks":["/x/"]},"frontmatter":{"title":"Git Hooks: Enforce Commit Message and Branch Name"}},"next":null,"translations":["tr"],"translatedLinks":[]}},"staticQueryHashes":["336482444"]}